name: Update OSM Cameras JSON

on:
  schedule:
    - cron: "0 0 * * *" # every 24 hours at midnight UTC
  workflow_dispatch:
    inputs:
      countries:
        description: 'Comma-separated country codes to fetch (default: uk). Example: "uk,us,fr"'
        required: false
        default: 'uk'

jobs:
  update_json:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: false  # allow push with PAT

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # Step 3: Install dependencies
      - name: Install dependencies
        run: pip install requests

      # Step 4: Run OSM fetch script (defaults to UK unless you specify others)
      - name: Run OSM fetch script
        env:
          # this comes from workflow_dispatch input; schedule runs will set it to 'uk'
          COUNTRIES: ${{ github.event.inputs.countries || 'uk,fr,de,es,it' }}
        run: |
          python - << 'EOF'
          import os
          import requests
          import json
          import time

          # CONFIGURATION
          CONF_FIXED = 80
          CONF_MOBILE_POSSIBLE = 60
          OVERPASS_URL = "https://lz4.overpass-api.de/api/interpreter"
          OUTPUT_DIR = "docs"
          os.makedirs(OUTPUT_DIR, exist_ok=True)

          # COUNTRY bounding boxes (lat_min, lon_min, lat_max, lon_max).
          # Add or refine bboxes as needed. Keep 'uk' filename as docs/osm_cameras.json for backwards compatibility.
          COUNTRY_BBOXES = {
              "uk": [
                  (49.9, -8.6, 55.0, -2.0),
                  (55.0, -8.6, 60.9, -2.0),
                  (49.9, -2.0, 55.0, 1.8),
                  (55.0, -2.0, 60.9, 1.8),
              ],
              "fr": [(41.3, -5.1, 51.1, 9.6)],
              "de": [(47.3, 5.9, 55.1, 15.0)],
              "es": [(36.0, -9.4, 43.8, 4.3)],
              "it": [(36.6, 6.6, 47.1, 18.5)],
              "nl": [(50.7, 3.4, 53.6, 7.2)],
              "be": [(49.5, 2.5, 51.5, 6.4)],
              "ie": [(51.4, -10.5, 55.4, -5.3)],
              "pt": [(36.9, -9.5, 42.1, -6.2)],
              "se": [(55.3, 11.1, 69.1, 24.2)],
              "no": [(57.9, 4.7, 71.2, 31.1)],
              "dk": [(54.5, 7.7, 57.9, 12.7)],
              "ch": [(45.8, 5.96, 47.8, 10.5)],
              "at": [(46.4, 9.5, 49.0, 17.2)],
              "pl": [(49.0, 14.1, 54.8, 24.1)],
              "cz": [(48.6, 12.1, 51.1, 19.1)],
              "hu": [(45.7, 16.1, 48.6, 22.9)],
              "ro": [(43.6, 20.3, 48.3, 29.7)],
              "bg": [(41.2, 22.4, 44.2, 28.6)],
              "gr": [(34.8, 19.6, 41.7, 28.3)],
              # Optional non-European markets (US included)
              "us": [(24.5, -125.0, 49.5, -66.9)],
              # Add more countries here as required...
          }

          # Which countries to fetch? Defaults to 'uk' if COUNTRIES env var is empty.
          env_countries = os.environ.get("COUNTRIES")
          if env_countries:
              wanted = [c.strip().lower() for c in env_countries.split(",") if c.strip()]
              # Only keep recognized countries from COUNTRY_BBOXES
              COUNTRY_BBOXES = {k: v for k, v in COUNTRY_BBOXES.items() if k in wanted}
          else:
              # default to uk for scheduled runs
              COUNTRY_BBOXES = {"uk": COUNTRY_BBOXES["uk"]}

          if not COUNTRY_BBOXES:
              print("No countries configured to fetch. Exiting.")
              raise SystemExit(0)

          def fetch_bbox(bbox, timeout=180, attempts=3):
              query = f"""
              [out:json][timeout:{timeout}];
              (
                node["highway"="speed_camera"]({bbox[0]},{bbox[1]},{bbox[2]},{bbox[3]});
                node["camera:type"="mobile"]({bbox[0]},{bbox[1]},{bbox[2]},{bbox[3]});
                node["radar"="yes"]({bbox[0]},{bbox[1]},{bbox[2]},{bbox[3]});
              );
              out;
              """
              for attempt in range(1, attempts + 1):
                  try:
                      print(f"  Fetching bbox {bbox} (attempt {attempt}/{attempts})...")
                      resp = requests.get(OVERPASS_URL, params={"data": query}, timeout=timeout + 30)
                      resp.raise_for_status()
                      return resp.json()
                  except requests.exceptions.RequestException as e:
                      print(f"    Warning: fetch failed: {e}")
                      if attempt < attempts:
                          time.sleep(5 * attempt)
                      else:
                          print("    Error: giving up on this bbox.")
                          return None

          for cc, bboxes in COUNTRY_BBOXES.items():
              print(f"Processing country: {cc} with {len(bboxes)} bbox(es)")
              all_results = []

              for bbox in bboxes:
                  data = fetch_bbox(bbox)
                  time.sleep(2)  # be gentle with Overpass
                  if not data:
                      continue

                  for node in data.get("elements", []):
                      tags = node.get("tags", {})
                      if tags.get("highway") == "speed_camera":
                          camera_type = "fixed_camera"
                          conf = CONF_FIXED
                      else:
                          camera_type = "mobile_possible_camera"
                          conf = CONF_MOBILE_POSSIBLE

                      camera = {
                          "id": f"osm-{node['id']}",
                          "lat": node.get("lat"),
                          "lon": node.get("lon"),
                          "type": camera_type,
                          "confidence": conf,
                      }
                      all_results.append(camera)

              unique_results = {cam["id"]: cam for cam in all_results}.values()
              final_json = {"results": list(unique_results)}

              if cc == "uk":
                  output_file = os.path.join(OUTPUT_DIR, "osm_cameras.json")
              else:
                  output_file = os.path.join(OUTPUT_DIR, f"{cc}_osm_cameras.json")

              with open(output_file, "w") as fh:
                  json.dump(final_json, fh, indent=2)

              print(f"  Saved {len(final_json['results'])} cameras to {output_file}")

          print("All done.")
          EOF

      # Step 5: Deploy docs/ to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4.0.0
        with:
          github_token: ${{ secrets.GH_PAT }}
          publish_dir: ./docs
